<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Bringing NumPy&#x27;s type-completeness score to nearly 90% | Pyrefly</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://pyrefly.org/blog/numpy-type-completeness/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Bringing NumPy&#x27;s type-completeness score to nearly 90% | Pyrefly"><meta data-rh="true" name="description" content="We tell the story of how we brought NumPy&#x27;s type-completeness score from ~33% to nearly 90%"><meta data-rh="true" property="og:description" content="We tell the story of how we brought NumPy&#x27;s type-completeness score from ~33% to nearly 90%"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-09-29T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/MarcoGorelli"><meta data-rh="true" property="article:tag" content="typechecking,news"><link data-rh="true" rel="canonical" href="https://pyrefly.org/blog/numpy-type-completeness/"><link data-rh="true" rel="alternate" href="https://pyrefly.org/blog/numpy-type-completeness/" hreflang="en"><link data-rh="true" rel="alternate" href="https://pyrefly.org/blog/numpy-type-completeness/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://pyrefly.org/blog/numpy-type-completeness","mainEntityOfPage":"https://pyrefly.org/blog/numpy-type-completeness","url":"https://pyrefly.org/blog/numpy-type-completeness","headline":"Bringing NumPy's type-completeness score to nearly 90%","name":"Bringing NumPy's type-completeness score to nearly 90%","description":"We tell the story of how we brought NumPy's type-completeness score from ~33% to nearly 90%","datePublished":"2025-09-29T00:00:00.000Z","author":{"@type":"Person","name":"Marco Gorelli, Quansight Labs","url":"https://github.com/MarcoGorelli"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://pyrefly.org/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Pyrefly RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Pyrefly Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GSX14JC495"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-GSX14JC495",{anonymize_ip:!0})</script>











<link rel="stylesheet" href="/stylex.css">


<link rel="icon" href="/img/Pyrefly-Symbol.svg" type="image/svg" sizes="32x32" media="(prefers-color-scheme: light)">
<link rel="icon" href="/img/Pyrefly-Symbol-Invert.svg" type="image/svg" sizes="32x32" media="(prefers-color-scheme: dark)">
<meta property="og:image" content="/img/Pyrefly-Preview-Symbol.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:type" content="image/png">
<link rel="stylesheet" href="/css/code-block-buttons.css">
<script src="https://buttons.github.io/buttons.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<script src="/js/code-block-buttons.js"></script><link rel="stylesheet" href="/assets/css/styles.2ccc2416.css">
<script src="/assets/js/runtime~main.c7979954.js" defer="defer"></script>
<script src="/assets/js/main.c75c0eff.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Pyrefly-Symbol.svg" alt="Pyrefly Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="24" width="24"><img src="/img/Pyrefly-Symbol-Invert.svg" alt="Pyrefly Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="24" width="24"></div><b class="navbar__title text--truncate">Pyrefly</b></a><a class="navbar__item navbar__link" href="/en/docs/">Docs</a><a class="navbar__item navbar__link" href="/en/docs/typing-for-python-developers/">Learn</a><a class="navbar__item navbar__link" href="/sandbox/">Sandbox</a><a class="navbar__item navbar__link" href="/en/docs/installation/">Install</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/pyrefly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__icon github__link" aria-label="GitHub"></a><a href="https://discord.gg/Cf7mFQtW7W" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__icon discord__link" aria-label="Discord"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2026</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2026/02/06/performance-improvements/">Making Pyrefly Diagnostics 18x Faster</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/type-narrowing/">4 Pyrefly Type Narrowing Patterns that make Type Checking more Intuitive</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pyrefly-pydantic/">Fly through data validation with Pyrefly’s new Pydantic integration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pyrefly-beta/">Pyrefly Beta is here!</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/numpy-type-completeness/">Bringing NumPy&#x27;s type-completeness score to nearly 90%</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/09/15/ide-extension/">Give your Python IDE a Glow-Up with Pyrefly</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/why-typed-python/">Why Today’s Python Developers Are Embracing Type Hints</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/introducing-pyrefly/">Introducing Pyrefly - A new type checker and IDE experience for Python</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Bringing NumPy&#x27;s type-completeness score to nearly 90%</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-09-29T00:00:00.000Z">September 29, 2025</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/MarcoGorelli" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Marco Gorelli, Quansight Labs</span></a></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Because <a href="https://numpy.org/" target="_blank" rel="noopener noreferrer">NumPy</a> is one of the most downloaded packages in the Python ecosystem, any incremental improvement can have a large impact on the data science ecosystem. In particular, improvements related to static typing can improve developer experience and help downstream libraries write safer code. We&#x27;ll tell the story about how we (Quansight Labs, with support from Meta&#x27;s Pyrefly team) helped bring its type-completeness score to nearly 90% from an initial 33%.</p>
<p><strong>TL;DR</strong>:</p>
<ul>
<li>NumPy&#x27;s type-completeness score was ~33%.</li>
<li>A one-line fix doubled coverage to over 80%.</li>
<li>Fully typing MaskedArray pushed the score to nearly 90%.</li>
<li>What&#x27;s left? Top-level <code>numpy.ma</code> functions, more precise overloads, and adding a type-checker to NumPy&#x27;s CI.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wait-whats-type-completeness">Wait, what&#x27;s type completeness?<a href="#wait-whats-type-completeness" class="hash-link" aria-label="Direct link to Wait, what&#x27;s type completeness?" title="Direct link to Wait, what&#x27;s type completeness?">​</a></h2>
<p>Modern IDEs use type annotations to help developers by showing them helpful suggestions and highlighting syntax. <a href="https://github.com/microsoft/pyright" target="_blank" rel="noopener noreferrer">Pyright</a> is a popular type-checker which, as well as checking for correctness and consistency, can also measure what percentage of a library&#x27;s public API has type annotations. We call the percentage of fully-typed symbols exported by a library the <em>type-completeness score</em>.</p>
<p>For example, a module which exports functions <code>foo</code> and <code>bar</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">foo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">bar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token number">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>would have a 50% type-completeness score, because:</p>
<ul>
<li><code>foo</code> is partially unknown, as it&#x27;s missing a return annotation.</li>
<li><code>bar</code> is type-complete.</li>
</ul>
<p>By changing the <code>foo</code> signature to be <code>def foo(a: int) -&gt; None:</code>, the type-completeness score would jump to 100%. The more type-complete a library is, the more helpful the suggestions an IDE can show to the user.</p>
<p>Note that type-completeness only measures how much of the public API (at least, the part known to Pyright) is covered by types. If you want to verify that those types are correct and self-consistent, you&#x27;ll also need to run a type checker. The most used type checkers currently are <a href="https://github.com/python/mypy" target="_blank" rel="noopener noreferrer">mypy</a> and Pyright, but <a href="https://github.com/facebook/pyrefly" target="_blank" rel="noopener noreferrer">Pyrefly</a> and <a href="https://github.com/astral-sh/ty" target="_blank" rel="noopener noreferrer">ty</a> are also attracting a lot of attention due to their impressive performance characteristics (note however that neither yet describes itself as production-ready, so temper your expectations accordingly if you try them out!).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-type-complete-is-numpy">How type-complete is NumPy?<a href="#how-type-complete-is-numpy" class="hash-link" aria-label="Direct link to How type-complete is NumPy?" title="Direct link to How type-complete is NumPy?">​</a></h2>
<p>When we started this effort (in March 2025), we first tried measuring NumPy&#x27;s type-completeness by running:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pyright --verifytypes numpy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The output showed a completeness score of...18%. Wait, only 18%? This seemed very low, because by then typing efforts in NumPy had been ongoing for some time. Was something up with the metric? Upon closer inspection of the output, we noticed a few things:</p>
<ul>
<li>Some objects, such as <code>DTypeLike</code>, were reported to be &quot;partially unknown&quot;, even though they had type annotations.</li>
<li>The type-completeness report included test modules such as <code>numpy.tests.test_matlib</code>.</li>
</ul>
<p>The first issue was caused by an import from the standard library <code>decimal</code> module, which itself is partially untyped. Given that this is outside of NumPy&#x27;s direct control, we decided to exclude it from the coverage report by using <code>--ignoreexternal</code>, <a href="https://github.com/microsoft/pyright/discussions/9911" target="_blank" rel="noopener noreferrer">as suggested by Eric Traut</a>.</p>
<p>For the second issue, Pyright gives us an option to export the coverage report to json (<code>--outputjson</code>). We could then parse the json and exclude <code>numpy.tests</code>. Given that NumPy users wouldn&#x27;t ordinarily interact with NumPy&#x27;s internal test suite but that Pyright considers it public, we decided that it made sense for us to exclude tests in order to focus our efforts on what would make the biggest user-facing impact.</p>
<p>Once we&#x27;d addressed the two steps above, the baseline type-completeness score became 33%. This was our starting point. We could then focus our efforts on the remaining 67%!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-one-line-change-which-doubled-type-completeness">The one-line change which doubled type-completeness<a href="#the-one-line-change-which-doubled-type-completeness" class="hash-link" aria-label="Direct link to The one-line change which doubled type-completeness" title="Direct link to The one-line change which doubled type-completeness">​</a></h2>
<p>Pyright&#x27;s report includes classes, methods, functions, type aliases, and more. A lot of scientific Python code centres around some central classes such as <code>numpy.ndarray</code>. <code>ndarray</code> was reported as &quot;partially unknown&quot;, but eye-balling the exported symbols related to that class revealed something interesting:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;isTypeKnown&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> x </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> exported </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;name&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;numpy.ndarray.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0.9811320754716981</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So, <code>ndarray</code> was reported as &quot;partially unknown&quot;, but 98% of its methods had known types. It shouldn&#x27;t be much effort to bring that number to 100%! In fact, all it took was a <a href="https://github.com/numpy/numpy/pull/28908" target="_blank" rel="noopener noreferrer">one-line change to fix a typo in a type annotation</a>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">- def setfield(self, /, val: ArrayLike, dtype: DTypeLike, offset: CanIndex = 0) -&gt; None: ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+ def setfield(self, /, val: ArrayLike, dtype: DTypeLike, offset: SupportsIndex = 0) -&gt; None: ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That&#x27;s it! <code>CanIndex</code> was an unknown symbol and was probably mistyped, and replacing it with the correct <code>SupportsIndex</code> one brought NumPy&#x27;s overall type-completeness to over 80%! We then started examining other NumPy classes to see if there was anywhere else where we could make an impact, and hopefully a much larger one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="enter-maskedarray">Enter MaskedArray<a href="#enter-maskedarray" class="hash-link" aria-label="Direct link to Enter MaskedArray" title="Direct link to Enter MaskedArray">​</a></h2>
<p>When we looked at the percentage of typed symbols from the MaskedArray class, we noticed something interesting:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;isTypeKnown&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> x </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> exported </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;name&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;numpy.ma.core.MaskedArray.&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">np</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0.2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Only 20% of them were typed! That&#x27;s quite a contrast with <code>ndarray</code>, which was already at 98% when we started. It&#x27;s also a fairly widely used class, appearing in the codebases of pandas, scikit-learn, and xarray. Given how poorly typed it was, we decided it would be a good candidate to spend time on!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="typing-maskedarray">Typing MaskedArray<a href="#typing-maskedarray" class="hash-link" aria-label="Direct link to Typing MaskedArray" title="Direct link to Typing MaskedArray">​</a></h2>
<p>The main difficulty in typing NumPy code isn&#x27;t inferring the possible argument values (which is quite easy to do with automated tools), but rather dealing with the large number of overloads. This is because many of NumPy methods&#x27; return types depend on the exact combinations of the input types. For example, suppose we have a <code>MaskedArray</code> <code>ma</code> and want to count the number of non-null values:</p>
<ul>
<li><code>ma.count()</code> returns an integer.</li>
<li><code>ma.count(axis=0)</code> returns an array.</li>
<li><code>ma.count(keepdims=True)</code> also returns an array, of the same shape as the input array.</li>
</ul>
<p>We can type this by having a different overload of each of these different cases. This is a relatively simple example, but there are others where the number of necessary overloads was as high as 9! This isn&#x27;t something which is easy to automate, and requires careful reading of the documentation and of the source code. It&#x27;s a non-trivial amount of work.</p>
<p>But...we pulled through it, and thanks to some very timely and constructive reviews from the amazing <a href="https://github.com/jorenham" target="_blank" rel="noopener noreferrer">Joren Hammudoglu</a>, MaskedArray is now reported as 100% type-complete! As for the overall type-completeness, that&#x27;s now at 88%. So...what&#x27;s left?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-missing-from-numpy">What&#x27;s missing from NumPy?<a href="#whats-missing-from-numpy" class="hash-link" aria-label="Direct link to What&#x27;s missing from NumPy?" title="Direct link to What&#x27;s missing from NumPy?">​</a></h2>
<p>In the MaskedArray module, there&#x27;s still some untyped top-level functions, such as <code>numpy.ma.count</code>. Overloads could be made more precise and shape-preserving (e.g. if the input is 2D, then make sure to preserve this fact in the output where possible). There&#x27;s some missing defaults in the stubs. There&#x27;s no shortage of work here.</p>
<p>The biggest missing bit, however, is the elephant in the room: NumPy doesn&#x27;t run a type-checker over its codebase in CI. It has some typing tests, sure, but that&#x27;s different from running a type-checker. If any motivated reader is interested in making a significant open source contribution, then getting NumPy&#x27;s typing into a state such that a type checker (and possibly even <a href="https://mypy.readthedocs.io/en/stable/stubtest.html" target="_blank" rel="noopener noreferrer">stubtest</a>) can be run over it could be a great use of your time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion-acknowledgements">Conclusion, acknowledgements<a href="#conclusion-acknowledgements" class="hash-link" aria-label="Direct link to Conclusion, acknowledgements" title="Direct link to Conclusion, acknowledgements">​</a></h2>
<p>We&#x27;ve looked at how we contributed towards increasing NumPy&#x27;s type-completeness. Given how widespread NumPy&#x27;s adoption is, we expect this effort to have been an impactful one. We look forward to seeing what else we can achieve in this space - thank you to <a href="https://discuss.python.org/t/call-for-suggestions-nominate-python-packages-for-typing-improvements/80186/1" target="_blank" rel="noopener noreferrer">Meta and Quansight Labs</a> for having funded and facilitated this effort!</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/typechecking/">typechecking</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/news/">news</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/pyrefly-beta/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Pyrefly Beta is here!</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2025/09/15/ide-extension/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Give your Python IDE a Glow-Up with Pyrefly</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#wait-whats-type-completeness" class="table-of-contents__link toc-highlight">Wait, what&#39;s type completeness?</a></li><li><a href="#how-type-complete-is-numpy" class="table-of-contents__link toc-highlight">How type-complete is NumPy?</a></li><li><a href="#the-one-line-change-which-doubled-type-completeness" class="table-of-contents__link toc-highlight">The one-line change which doubled type-completeness</a></li><li><a href="#enter-maskedarray" class="table-of-contents__link toc-highlight">Enter MaskedArray</a></li><li><a href="#typing-maskedarray" class="table-of-contents__link toc-highlight">Typing MaskedArray</a></li><li><a href="#whats-missing-from-numpy" class="table-of-contents__link toc-highlight">What&#39;s missing from NumPy?</a></li><li><a href="#conclusion-acknowledgements" class="table-of-contents__link toc-highlight">Conclusion, acknowledgements</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community &amp; Support</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/Cf7mFQtW7W" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/pyrefly" target="_blank" rel="noopener noreferrer" class="footer__link-item">Open a Github issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/MuFSdD7uCr?event=1389635637090713672" target="_blank" rel="noopener noreferrer" class="footer__link-item">Attend Office Hours<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.fb.com/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/meta_open_source_logo.svg" alt="Meta Open Source Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/meta_open_source_logo.svg" alt="Meta Open Source Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">Copyright © 2026 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>